<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Transfer√™ncia de Material</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-title">
                    <h1>Sistema de Transfer√™ncia de Material</h1>
                    <div class="header-subtitle">Painel de Controle - Intercompany</div>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;" id="user-name">Carregando...</div>
                        <div style="font-size: 12px; opacity: 0.9;" id="user-role"></div>
                    </div>
                    <div class="user-avatar" id="user-avatar">?</div>
                </div>
                <button class="btn-logout" onclick="handleLogout()">Sair</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="app-nav">
        <div class="nav-container">
            <a href="#dashboard" class="nav-link active" onclick="showTab('dashboard')">üìä Dashboard</a>
            <a href="#imports" class="nav-link" id="tab-imports" style="display:none" onclick="showTab('imports')">üì• Importa√ß√µes</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div id="dashboard-section" class="container">
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card primary clickable" onclick="filterByAll()">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Total de Solicita√ß√µes</div>
                        <div class="stat-value" id="stat-total">-</div>
                    </div>
                    <div class="stat-icon">üì¶</div>
                </div>
            </div>

            <div class="stat-card danger clickable" onclick="filterByOverdue()">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Em Atraso</div>
                        <div class="stat-value" id="stat-atrasados">-</div>
                    </div>
                    <div class="stat-icon">‚ö†Ô∏è</div>
                </div>
            </div>

            <div class="stat-card warning clickable" onclick="filterByDueToday()">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Vencem Hoje</div>
                        <div class="stat-value" id="stat-hoje">-</div>
                    </div>
                    <div class="stat-icon">üïê</div>
                </div>
            </div>

            <div class="stat-card success clickable" onclick="filterByCompleted()">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Conclu√≠dos</div>
                        <div class="stat-value" id="stat-concluidos">-</div>
                    </div>
                    <div class="stat-icon">‚úÖ</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-panel">
            <h3 class="filters-panel-title">Filtros</h3>
            <div class="controls-row filters-row">
                <div class="filters-group filters-group-main">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="üîç Buscar por material ou solicitante...">
                    </div>
                    <input type="number" id="filter-id" class="filter-input-id" placeholder="ID" min="1" step="1">
                    <select id="filter-status" class="filter-select">
                        <option value="">Todos os Status</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Separa√ß√£o">Em Separa√ß√£o</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                        <option value="Cancelado">Cancelado</option>
                        <option value="Recusado">Recusado</option>
                    </select>
                    <select id="filter-urgencia" class="filter-select">
                        <option value="">Todas as Urg√™ncias</option>
                        <option value="Urgente">Urgente</option>
                        <option value="Normal">Normal</option>
                    </select>
                    <div id="filter-group-entregar-em" class="filters-group-entregar-em" style="display: none;">
                        <label for="filter-entregar-em" class="filter-label">Entregar em</label>
                        <select id="filter-entregar-em" class="filter-select">
                            <option value="">Todos</option>
                            <option value="Grafica">Gr√°fica</option>
                            <option value="Salto">Salto</option>
                            <option value="Flexiveis">Flex√≠veis</option>
                        </select>
                    </div>
                </div>
                <div class="filters-group filters-group-dates">
                    <div class="date-filter-group">
                        <label for="filter-data-solicitacao-inicio" class="filter-label">Data Solicita√ß√£o</label>
                        <input type="date" id="filter-data-solicitacao-inicio" placeholder="De">
                        <span class="date-sep">at√©</span>
                        <input type="date" id="filter-data-solicitacao-fim" placeholder="At√©">
                    </div>
                    <div class="date-filter-group">
                        <label for="filter-prazo-inicio" class="filter-label">Prazo</label>
                        <input type="date" id="filter-prazo-inicio" placeholder="De">
                        <span class="date-sep">at√©</span>
                        <input type="date" id="filter-prazo-fim" placeholder="At√©">
                    </div>
                </div>
                <div class="filters-actions">
                    <button type="button" class="btn btn-secondary btn-small" onclick="limparFiltros()">Limpar</button>
                    <button type="button" class="btn btn-secondary btn-small" onclick="downloadTemplate()">Template Excel</button>
                    <label class="btn btn-info btn-small btn-import">
                        Importar Excel
                        <input type="file" id="import-file" accept=".xlsx,.xls" style="display: none;" onchange="handleImportFile(event)">
                    </label>
                    <button type="button" class="btn btn-success btn-primary-action" onclick="openRequestModal()">+ Nova Solicita√ß√£o</button>
                </div>
            </div>
        </div>

        <!-- Selection Actions -->
        <div id="selection-actions" style="display: none; margin-bottom: 15px;">
            <span id="selection-info">0 itens selecionados</span>
            <button class="btn btn-primary btn-small" onclick="printSelected()" style="margin-left: 10px;">üñ®Ô∏è Imprimir Selecionados</button>
            <button class="btn btn-success btn-small" onclick="exportSelectedToExcel()" style="margin-left: 10px;">üì• Exportar Excel</button>
        </div>

        <!-- Pagination Controls -->
        <div id="pagination-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: var(--card-bg); border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="page-size-select" style="font-size: 14px;">Itens por p√°gina:</label>
                <select id="page-size-select" style="padding: 5px 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text);">
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                    <option value="2000">2000</option>
                </select>
            </div>
            <div id="pagination-info" style="font-size: 14px; color: var(--text-secondary);">
                P√°gina 1 de 1 (0 itens)
            </div>
            <div style="display: flex; gap: 5px;">
                <button id="prev-page-btn" class="btn btn-secondary btn-small" disabled>‚Üê Anterior</button>
                <button id="next-page-btn" class="btn btn-secondary btn-small" disabled>Pr√≥xima ‚Üí</button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>ID</th>
                        <th>Data Solicita√ß√£o</th>
                        <th>Urg√™ncia</th>
                        <th>Prazo</th>
                        <th>C√≥digo</th>
                        <th>Descri√ß√£o</th>
                        <th>Solicitante</th>
                        <th>Entregar em</th>
                        <th>N¬∫ Remessa</th>
                        <th>Qtd/Unid</th>
                        <th>Status</th>
                        <th>Observa√ß√£o</th>
                        <th>Atualizado</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="requests-tbody">
                    <tr>
                        <td colspan="15" style="text-align: center; padding: 40px;">
                            Carregando...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Imports Section (Admin only) -->
    <div id="imports-section" class="container" style="display: none;">
        <div class="section-header">
            <h2>üì• Importa√ß√µes</h2>
            <p>Lotes de importa√ß√£o e arquivos originais</p>
        </div>
        <div id="imports-batches"></div>
        <div id="imports-items" style="margin-top:16px"></div>
    </div>

    <!-- Modal de Solicita√ß√£o -->
    <div class="modal-overlay" id="request-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Nova Solicita√ß√£o</h2>
                <p id="modal-subtitle">Preencha os dados para criar uma nova solicita√ß√£o</p>
            </div>
            <div class="modal-body">
                <form id="request-form">
                    <input type="hidden" id="request-id">

                    <div class="form-group">
                        <label for="material-code">C√≥digo do Material *</label>
                        <input type="text" id="material-code" required placeholder="Ex: MP001, COMP002">
                    </div>

                    <div class="form-group">
                        <label for="material-description">Descri√ß√£o do Material *</label>
                        <input type="text" id="material-description" required placeholder="Ex: Mat√©ria-Prima X123 - A√ßo inoxid√°vel">
                    </div>

                    <div class="form-group">
                        <label for="quantidade">Quantidade *</label>
                        <input type="number" id="quantidade" required min="1" step="1" placeholder="Ex: 100 ou 5439">
                    </div>

                    <div class="form-group">
                        <label for="unidade">Unidade *</label>
                        <select id="unidade" required>
                            <option value="">Selecione a unidade</option>
                            <option value="kg">kg (Quilograma)</option>
                            <option value="pc">pc (Pe√ßa)</option>
                            <option value="m">m (Metro)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="solicitante">Solicitante *</label>
                        <input type="text" id="solicitante" required placeholder="Nome do solicitante">
                    </div>

                    <div class="form-group" id="form-group-entregar-em">
                        <label for="entregar-em">Entregar em *</label>
                        <select id="entregar-em" required>
                            <option value="">Selecione</option>
                            <option value="Grafica">Gr√°fica</option>
                            <option value="Salto">Salto</option>
                            <option value="Flexiveis">Flex√≠veis</option>
                        </select>
                    </div>

                    <div class="form-group" id="form-group-numero-remessa" style="display: none;">
                        <label for="numero-remessa">N¬∫ Remessa</label>
                        <input type="text" id="numero-remessa" placeholder="Preenchido pelo separador">
                    </div>

                    <div class="form-group">
                        <label for="urgencia">Urg√™ncia</label>
                        <select id="urgencia">
                            <option value="Normal">Normal</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="prazo">Prazo *</label>
                        <input type="date" id="prazo" required>
                    </div>

                    <div class="form-group">
                        <label for="inicio-producao">In√≠cio de Produ√ß√£o</label>
                        <input type="date" id="inicio-producao">
                    </div>

                    <div class="form-group">
                        <label for="justificativa">Justificativa</label>
                        <textarea id="justificativa" placeholder="Opcional: descreva o motivo da solicita√ß√£o"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRequestModal()">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveRequest()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Hist√≥rico -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Hist√≥rico da Solicita√ß√£o</h2>
                <p>Timeline completa de altera√ß√µes</p>
            </div>
            <div class="modal-body">
                <div id="history-timeline" class="timeline">
                    <p style="text-align: center; color: var(--text-secondary);">Carregando hist√≥rico...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeHistoryModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Recusa -->
    <div class="modal-overlay" id="modal-recusa">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Recusar Solicita√ß√£o</h2>
                <p><strong>Motivo:</strong> Produto n√£o dispon√≠vel em estoque</p>
            </div>
            <div class="modal-body">
                <label for="motivo-recusa">Justificativa da Falta *</label>
                <textarea 
                    id="motivo-recusa" 
                    rows="4" 
                    placeholder="Descreva o motivo da falta (ex: produto esgotado, aguardando reposi√ß√£o, etc.)"
                    required
                ></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="fecharModalRecusa()">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarRecusa()">Confirmar Recusa</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { requireAuth, getCurrentUser, logout, isAdmin, isSeparador } from '/js/auth.js';
        import { getRequests, getRequest, getDashboardStats, createRequest, updateRequest, deleteRequest, getRequestHistory, printPickingList } from '/js/api.js';

        // Verificar token ao carregar p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('auth_token');
            const user = localStorage.getItem('current_user');
            
            // Se tem user mas n√£o tem token, limpar tudo e redirecionar
            if (user && !token) {
                console.warn('Usu√°rio sem token v√°lido, redirecionando para login');
                localStorage.removeItem('current_user');
                window.location.href = 'login.html';
                return;
            }
            
            // Se n√£o tem nem user nem token, redirecionar
            if (!user && !token) {
                window.location.href = 'login.html';
                return;
            }
        });

        // Verificar autentica√ß√£o
        if (!requireAuth()) {
            window.location.href = '/login.html';
        }

        // Estado global
        let currentRequests = [];
        let selectedIds = new Set();
        let editingRequestId = null;
        
        // Pagina√ß√£o
        let currentPage = 1;
        let pageSize = 100;
        let total = 0;

        function getErrorMessage(err) {
            if (err instanceof Error) return err.message;
            if (err != null && typeof err === 'object' && typeof err.message === 'string') return err.message;
            return err != null ? String(err) : 'Erro desconhecido';
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            initializeUser();
            setupRoleVisibility();
            loadDashboard();
            loadRequests();
            setupEventListeners();
        });

        function initializeUser() {
            const user = getCurrentUser();
            if (!user) return;

            const userName = user.name || user.nome || 'Usu√°rio';
            const userRole = user.role || 'user';
            
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-role').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
            
            const initials = userName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;
        }

        function setupRoleVisibility() {
            const user = getCurrentUser();
            if (!user) return;
            
            // Esconder funcionalidades para separador (s√≥ pode processar, n√£o criar)
            if (user.role === 'separador') {
                // Esconder importa√ß√£o Excel
                const importLabel = document.querySelector('label.btn-info');
                if (importLabel) importLabel.style.display = 'none';
                
                // Esconder template Excel
                const templateBtn = document.querySelector('.btn-secondary');
                if (templateBtn && templateBtn.textContent.includes('Template')) {
                    templateBtn.style.display = 'none';
                }
                
                // Esconder bot√£o Nova Solicita√ß√£o
                const novaSolicitacaoBtn = document.querySelector('button.btn-success');
                if (novaSolicitacaoBtn && novaSolicitacaoBtn.textContent.includes('Nova Solicita√ß√£o')) {
                    novaSolicitacaoBtn.style.display = 'none';
                }
            }

            // Mostrar aba Importa√ß√µes apenas para admin
            if (user.role === 'admin') {
                const tab = document.getElementById('tab-imports');
                if (tab) tab.style.display = '';
            }
            // Mostrar filtro "Entregar em" apenas para separador e admin
            const filterGroupEntregarEm = document.getElementById('filter-group-entregar-em');
            if (filterGroupEntregarEm) filterGroupEntregarEm.style.display = (user.role === 'admin' || user.role === 'separador') ? '' : 'none';
        }

        function setupEventListeners() {
            // Resetar p√°gina quando filtros mudam
            document.getElementById('search-input').addEventListener('input', debounce(() => loadRequests(true), 300));
            document.getElementById('filter-id').addEventListener('input', debounce(() => loadRequests(true), 300));
            document.getElementById('filter-status').addEventListener('change', () => loadRequests(true));
            document.getElementById('filter-urgencia').addEventListener('change', () => loadRequests(true));
            const filterEntregarEm = document.getElementById('filter-entregar-em');
            if (filterEntregarEm) filterEntregarEm.addEventListener('change', () => loadRequests(true));
            document.getElementById('filter-data-solicitacao-inicio').addEventListener('change', debounce(() => loadRequests(true), 400));
            document.getElementById('filter-data-solicitacao-fim').addEventListener('change', debounce(() => loadRequests(true), 400));
            document.getElementById('filter-prazo-inicio').addEventListener('change', debounce(() => loadRequests(true), 400));
            document.getElementById('filter-prazo-fim').addEventListener('change', debounce(() => loadRequests(true), 400));
            document.getElementById('select-all').addEventListener('change', handleSelectAll);
            
            // Listener para mudan√ßa de tamanho de p√°gina
            const pageSizeSelect = document.getElementById('page-size-select');
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', (e) => changePageSize(e.target.value));
            }
            
            // Listeners para bot√µes de pagina√ß√£o
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(total / pageSize);
                    if (currentPage > 1) {
                        currentPage = currentPage - 1;
                        loadRequests();
                    }
                });
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(total / pageSize);
                    if (currentPage < totalPages && totalPages > 0) {
                        currentPage = currentPage + 1;
                        loadRequests();
                    }
                });
            }

            // Fechar modais ao clicar fora
            document.getElementById('request-modal').addEventListener('click', (e) => {
                if (e.target.id === 'request-modal') closeRequestModal();
            });
            document.getElementById('history-modal').addEventListener('click', (e) => {
                if (e.target.id === 'history-modal') closeHistoryModal();
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        async function loadDashboard() {
            try {
                const stats = await getDashboardStats();
                document.getElementById('stat-total').textContent = stats.total;
                document.getElementById('stat-atrasados').textContent = stats.atrasados;
                document.getElementById('stat-hoje').textContent = stats.vencem_hoje;
                document.getElementById('stat-concluidos').textContent = stats.concluidos;
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        async function loadRequests(resetPage = false) {
            // Resetar p√°gina se necess√°rio (quando filtros mudam)
            if (resetPage) {
                currentPage = 1;
            }
            
            const search = document.getElementById('search-input').value;
            const filterId = document.getElementById('filter-id').value;
            const status = document.getElementById('filter-status').value;
            const urgencia = document.getElementById('filter-urgencia').value;
            const dataSolicitacaoInicio = document.getElementById('filter-data-solicitacao-inicio').value;
            const dataSolicitacaoFim = document.getElementById('filter-data-solicitacao-fim').value;
            const prazoInicio = document.getElementById('filter-prazo-inicio').value;
            const prazoFim = document.getElementById('filter-prazo-fim').value;
            const filterEntregarEmEl = document.getElementById('filter-entregar-em');
            const entregarEm = filterEntregarEmEl ? filterEntregarEmEl.value : '';

            const filters = {
                page: currentPage,
                limit: pageSize
            };
            if (search) filters.search = search;
            if (filterId) filters.id = filterId;
            if (status) filters.status = status;
            if (urgencia) filters.urgencia = urgencia;
            if (entregarEm) filters.entregar_em = entregarEm;
            if (dataSolicitacaoInicio) filters.created_at_start = dataSolicitacaoInicio;
            if (dataSolicitacaoFim) filters.created_at_end = dataSolicitacaoFim;
            if (prazoInicio) filters.deadline_start = prazoInicio;
            if (prazoFim) filters.deadline_end = prazoFim;

            try {
                const response = await getRequests(filters);
                
                // Verificar se √© a nova estrutura (com pagina√ß√£o) ou antiga (array direto)
                if (response && typeof response === 'object' && 'data' in response) {
                    // Nova estrutura com pagina√ß√£o
                    currentRequests = response.data || [];
                    total = response.total || 0;
                    currentPage = response.page || 1;
                    pageSize = response.pageSize || 100;
                } else {
                    // Estrutura antiga (array direto) - compatibilidade
                    currentRequests = Array.isArray(response) ? response : [];
                    total = currentRequests.length;
                }
                
                renderRequests();
                updatePaginationControls();
            } catch (error) {
                if (error && error.name === 'AbortError') {
                    console.log('Requisi√ß√£o cancelada');
                    return;
                }
                console.error('Erro ao carregar solicita√ß√µes:', error);
                document.getElementById('requests-tbody').innerHTML = `
                    <tr><td colspan="15" style="text-align: center; color: var(--danger);">
                        Erro ao carregar solicita√ß√µes: ${getErrorMessage(error)}
                    </td></tr>
                `;
            }
        }

        function getActionButtons(req) {
            const user = getCurrentUser();
            if (!user) return '';
            
            const userRole = user.role;
            const isOwner = req.created_by === user.id || req.requester_name === (user.name || user.nome);
            const isCompleted = req.status === 'Conclu√≠do';
            
            let buttons = '';
            
            if (userRole === 'admin') {
                // Admin: pode fazer tudo
                if (!isCompleted) {
                    buttons += `<button class="btn btn-primary btn-small" onclick="editRequest(${req.id})" title="Editar">‚úèÔ∏è</button>`;
                    buttons += `<button class="btn btn-success btn-small" onclick="completeRequest(${req.id})" title="Concluir">‚úì</button>`;
                    buttons += `<button class="btn btn-warning btn-small" onclick="updateStatus(${req.id}, 'Em Separa√ß√£o')" title="Marcar como Em Separa√ß√£o">üì¶</button>`;
                } else {
                    // Bot√£o para reverter de Conclu√≠do para Em Separa√ß√£o
                    buttons += `<button class="btn btn-warning btn-small" onclick="revertToSeparation(${req.id})" title="Reverter para Em Separa√ß√£o">‚Ü©Ô∏è</button>`;
                }
                // Bot√£o de exclus√£o (sempre vis√≠vel para admin)
                buttons += `<button class="btn btn-danger btn-small" onclick="deleteRequest(${req.id})" title="Excluir">üóëÔ∏è</button>`;
            } else if (userRole === 'separador') {
                // Separador: pode alterar status e concluir, mas n√£o editar dados
                if (!isCompleted) {
                    if (req.status === 'Pendente') {
                        buttons += `<button class="btn btn-warning btn-small" onclick="updateStatus(${req.id}, 'Em Separa√ß√£o')" title="Iniciar Separa√ß√£o">üì¶</button>`;
                    } else if (req.status === 'Em Separa√ß√£o') {
                        buttons += `<button class="btn btn-success btn-small" onclick="completeRequest(${req.id})" title="Concluir">‚úì</button>`;
                        buttons += `<button class="btn btn-danger btn-small" onclick="recusarSeparacao(${req.id})" title="Recusar (Sem Estoque)">üö´</button>`;
                    }
                } else {
                    // Bot√£o para reverter de Conclu√≠do para Em Separa√ß√£o
                    buttons += `<button class="btn btn-warning btn-small" onclick="revertToSeparation(${req.id})" title="Reverter para Em Separa√ß√£o">‚Ü©Ô∏è</button>`;
                }
            } else if (userRole === 'solicitante') {
                // Solicitante: s√≥ pode cancelar suas pr√≥prias solicita√ß√µes
                if (isOwner && !isCompleted) {
                    if (['Pendente', 'Em Separa√ß√£o'].includes(req.status)) {
                        buttons += `<button class="btn btn-danger btn-small" onclick="cancelRequest(${req.id})" title="Cancelar">‚ùå</button>`;
                    }
                }
            }
            
            return buttons;
        }

        function renderRequests() {
            const tbody = document.getElementById('requests-tbody');
            
            if (currentRequests.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="15" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        Nenhuma solicita√ß√£o encontrada
                    </td></tr>
                `;
                updateStatsFromFiltered();
                return;
            }

            const entregarEmLabel = (v) => ({ Grafica: 'Gr√°fica', Salto: 'Salto', Flexiveis: 'Flex√≠veis' }[v] || v || '-');
            // Destaque em verde para solicita√ß√µes de Salto e Flex√≠veis (facilita visualiza√ß√£o do separador)
            const isFlexiveisSalto = (name) => (name && (name === 'Flex√≠veis' || name === 'Salto'));
            tbody.innerHTML = currentRequests.map(req => {
                const reqName = req.solicitante_nome || req.requester_name;
                const rowClass = isFlexiveisSalto(reqName) ? 'row-flexiveis-salto' : '';
                return `
                <tr class="${rowClass}">
                    <td><input type="checkbox" class="row-checkbox" data-id="${req.id}"></td>
                    <td><strong>#${req.id}</strong></td>
                    <td>${formatDate(req.created_at)}</td>
                    <td>
                        <span class="badge ${req.urgencia.toLowerCase()}">${req.urgencia}</span>
                    </td>
                    <td>${formatPrazo(req.deadline, req.status)}</td>
                    <td><strong>${req.material_code || req.material}</strong></td>
                    <td>${req.material_description || '-'}</td>
                    <td>${reqName}</td>
                    <td>${entregarEmLabel(req.entregar_em)}</td>
                    <td>${req.numero_remessa || '-'}</td>
                    <td>${Math.ceil(Number(req.quantidade)).toLocaleString('pt-BR')} ${req.unidade || ''}</td>
                    <td>
                        <span class="badge ${req.status.toLowerCase().replace(' ', '-')}">${req.status}</span>
                    </td>
                    <td>${req.justificativa ? (req.justificativa.length > 50 ? req.justificativa.substring(0, 50) + '...' : req.justificativa) : '-'}</td>
                    <td>${formatDateTime(req.updated_at)}</td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="showHistory(${req.id})" title="Hist√≥rico">üìã</button>
                        ${getActionButtons(req)}
                    </td>
                </tr>
            `;
            }).join('');

            // Adicionar event listeners aos checkboxes
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.addEventListener('change', handleCheckboxChange);
            });

            updateStatsFromFiltered();
        }

        function formatPrazo(deadline, status) {
            if (!deadline || status === 'Conclu√≠do') return '-';
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            // FIX: Validar deadline antes de processar
            let deadlineDate;
            try {
                // Limpar deadline - pode vir com timezone ou n√£o
                let cleanDeadline = deadline;
                if (typeof deadline === 'string') {
                    // Se tem timezone, extrair apenas a data
                    if (deadline.includes('T')) {
                        cleanDeadline = deadline.split('T')[0];
                    }
                    // Adicionar timezone para evitar problemas
                    deadlineDate = new Date(cleanDeadline + 'T12:00:00');
                } else {
                    // Se n√£o √© string, tentar converter
                    deadlineDate = new Date(deadline);
                }
                
                // Validar se √© uma data v√°lida
                if (isNaN(deadlineDate.getTime())) {
                    console.warn('Data inv√°lida no prazo:', deadline);
                    return '-';
                }
                
                deadlineDate.setHours(0, 0, 0, 0);
            } catch (error) {
                console.error('Erro ao formatar prazo:', deadline, error);
                return '-';
            }
            
            const diff = Math.ceil((deadlineDate - hoje) / (1000 * 60 * 60 * 24));
            
            let className = '';
            let label = '';
            
            if (diff < 0) {
                className = 'danger';
                label = `<br><small>(${Math.abs(diff)} dias de atraso)</small>`;
            } else if (diff === 0) {
                className = 'warning';
                label = '<br><small>(Vence hoje!)</small>';
            } else {
                className = 'success';
                label = `<br><small>(${diff} dias)</small>`;
            }
            
            return `<span style="color: var(--${className}); font-weight: 600;">${deadlineDate.toLocaleDateString('pt-BR')}${label}</span>`;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString('pt-BR');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(total / pageSize);
            const paginationInfo = document.getElementById('pagination-info');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            const pageSizeSelect = document.getElementById('page-size-select');
            
            if (paginationInfo) {
                paginationInfo.textContent = `P√°gina ${currentPage} de ${totalPages || 1} (${total.toLocaleString('pt-BR')} itens)`;
            }
            
            if (prevBtn) {
                prevBtn.disabled = currentPage <= 1;
            }
            
            if (nextBtn) {
                nextBtn.disabled = currentPage >= totalPages || totalPages === 0;
            }
            
            if (pageSizeSelect) {
                pageSizeSelect.value = pageSize.toString();
            }
        }
        
        window.goToPage = function(page) {
            const totalPages = Math.ceil(total / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadRequests();
        }
        
        window.changePageSize = function(newSize) {
            pageSize = parseInt(newSize);
            currentPage = 1;
            loadRequests();
        }

        function limparFiltros() {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-id').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-urgencia').value = '';
            const fe = document.getElementById('filter-entregar-em');
            if (fe) fe.value = '';
            document.getElementById('filter-data-solicitacao-inicio').value = '';
            document.getElementById('filter-data-solicitacao-fim').value = '';
            document.getElementById('filter-prazo-inicio').value = '';
            document.getElementById('filter-prazo-fim').value = '';
            currentPage = 1;
            loadDashboard();  // Recarregar totais do backend
            loadRequests();
        }

        function hasActiveFilters() {
            const fe = document.getElementById('filter-entregar-em');
            return !!(
                document.getElementById('search-input').value ||
                document.getElementById('filter-id').value ||
                document.getElementById('filter-status').value ||
                document.getElementById('filter-urgencia').value ||
                (fe && fe.value) ||
                document.getElementById('filter-data-solicitacao-inicio').value ||
                document.getElementById('filter-data-solicitacao-fim').value ||
                document.getElementById('filter-prazo-inicio').value ||
                document.getElementById('filter-prazo-fim').value
            );
        }

        function updateStatsFromFiltered() {
            // Se n√£o h√° filtros ativos, n√£o atualizar (preservar dados do dashboard/backend)
            if (!hasActiveFilters()) {
                return;
            }
            
            const total = currentRequests.length;
            
            // Contar conclu√≠dos
            const concluidos = currentRequests.filter(r => r.status === 'Conclu√≠do').length;
            
            // Contar em atraso (deadline < hoje e status n√£o √© Conclu√≠do/Cancelado/Recusado)
            const hoje = new Date().toISOString().split('T')[0];
            const atrasados = currentRequests.filter(r => {
                if (!r.deadline || r.status === 'Conclu√≠do' || r.status === 'Cancelado' || r.status === 'Recusado') return false;
                const deadlineDate = r.deadline.split('T')[0];
                return deadlineDate < hoje;
            }).length;
            
            // Contar vencem hoje
            const vencemHoje = currentRequests.filter(r => {
                if (!r.deadline || r.status === 'Conclu√≠do' || r.status === 'Cancelado' || r.status === 'Recusado') return false;
                const deadlineDate = r.deadline.split('T')[0];
                return deadlineDate === hoje;
            }).length;
            
            // Atualizar DOM
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-atrasados').textContent = atrasados;
            document.getElementById('stat-hoje').textContent = vencemHoje;
            document.getElementById('stat-concluidos').textContent = concluidos;
        }

        window.limparFiltros = limparFiltros;
        window.updateStatsFromFiltered = updateStatsFromFiltered;

        function handleSelectAll(e) {
            const checked = e.target.checked;
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = checked;
            });
            updateSelectedIds();
        }

        function handleCheckboxChange() {
            updateSelectedIds();
        }

        function updateSelectedIds() {
            selectedIds.clear();
            document.querySelectorAll('.row-checkbox:checked').forEach(cb => {
                selectedIds.add(parseInt(cb.dataset.id));
            });

            const count = selectedIds.size;
            document.getElementById('selection-info').textContent = `${count} ${count === 1 ? 'item selecionado' : 'itens selecionados'}`;
            document.getElementById('selection-actions').style.display = count > 0 ? 'block' : 'none';
        }

        function isSaltoUser(user) {
            return user && (user.email === 'salto@antilhas.com' || (user.name && user.name.trim() === 'Salto') || (user.nome && user.nome.trim() === 'Salto'));
        }
        function isFlexiveisUser(user) {
            return user && (user.email === 'flexiveis@antilhas.com' || (user.name && user.name.trim() === 'Flex√≠veis') || (user.nome && user.nome.trim() === 'Flex√≠veis'));
        }
        function isDefaultSolicitante(user) {
            return user && user.role === 'solicitante' && !isSaltoUser(user) && !isFlexiveisUser(user);
        }
        function isSaltoRequest(req) {
            if (!req) return false;
            const name = req.solicitante_nome || req.requester_name;
            return name && String(name).trim() === 'Salto';
        }

        window.openRequestModal = function() {
            editingRequestId = null;
            document.getElementById('modal-title').textContent = 'Nova Solicita√ß√£o';
            document.getElementById('modal-subtitle').textContent = 'Preencha os dados para criar uma nova solicita√ß√£o';
            document.getElementById('request-form').reset();
            document.getElementById('request-id').value = '';
            const user = getCurrentUser();
            const entregarEmGroup = document.getElementById('form-group-entregar-em');
            const entregarEmSelect = document.getElementById('entregar-em');
            if (isSaltoUser(user)) {
                entregarEmSelect.value = 'Salto';
                if (entregarEmGroup) entregarEmGroup.style.display = 'none';
            } else if (isFlexiveisUser(user)) {
                entregarEmSelect.value = 'Flexiveis';
                if (entregarEmGroup) entregarEmGroup.style.display = 'none';
            } else if (isDefaultSolicitante(user)) {
                entregarEmSelect.value = 'Grafica';
                if (entregarEmGroup) entregarEmGroup.style.display = 'none';
            } else {
                entregarEmSelect.value = '';
                if (entregarEmGroup) entregarEmGroup.style.display = 'block';
            }
            const showNumeroRemessa = isSaltoUser(user);
            document.getElementById('form-group-numero-remessa').style.display = showNumeroRemessa ? 'block' : 'none';
            const numeroRemessaInput = document.getElementById('numero-remessa');
            if (numeroRemessaInput) numeroRemessaInput.required = showNumeroRemessa;
            if (user && (user.name || user.nome)) {
                document.getElementById('solicitante').value = user.name || user.nome;
            }
            document.getElementById('request-modal').classList.add('active');
        };

        window.closeRequestModal = function() {
            document.getElementById('request-modal').classList.remove('active');
        };

        window.editRequest = function(id) {
            const request = currentRequests.find(r => r.id === id);
            if (!request) return;

            editingRequestId = id;
            document.getElementById('modal-title').textContent = 'Editar Solicita√ß√£o';
            document.getElementById('modal-subtitle').textContent = `Editando solicita√ß√£o #${id}`;
            
            document.getElementById('request-id').value = id;
            document.getElementById('material-code').value = request.material_code || '';
            document.getElementById('material-description').value = request.material_description || '';
            document.getElementById('quantidade').value = request.quantidade;
            document.getElementById('unidade').value = request.unidade || '';
            document.getElementById('solicitante').value = request.solicitante_nome || request.requester_name || '';
            document.getElementById('entregar-em').value = request.entregar_em || '';
            document.getElementById('numero-remessa').value = request.numero_remessa || '';
            document.getElementById('urgencia').value = request.urgencia;
            const prazoValue = request.deadline ? request.deadline.split('T')[0] : '';
            document.getElementById('prazo').value = prazoValue;
            document.getElementById('justificativa').value = request.justificativa || '';

            const user = getCurrentUser();
            const canChooseEntregarEm = user && (user.role === 'admin' || user.role === 'separador');
            const entregarEmGroup = document.getElementById('form-group-entregar-em');
            if (entregarEmGroup) entregarEmGroup.style.display = canChooseEntregarEm ? 'block' : 'none';
            const isSaltoReq = isSaltoRequest(request);
            const showNumeroRemessa = isSaltoReq || (user && (user.role === 'separador' || user.role === 'admin'));
            document.getElementById('form-group-numero-remessa').style.display = showNumeroRemessa ? 'block' : 'none';
            const numeroRemessaInput = document.getElementById('numero-remessa');
            if (numeroRemessaInput) numeroRemessaInput.required = isSaltoReq;

            document.getElementById('request-modal').classList.add('active');
        };

        window.saveRequest = async function() {
            const id = document.getElementById('request-id').value;
            const user = getCurrentUser();
            const numeroRemessaEl = document.getElementById('numero-remessa');
            const numeroRemessaGroup = numeroRemessaEl && numeroRemessaEl.closest('.form-group');
            const isNumeroRemessaVisible = numeroRemessaGroup && numeroRemessaGroup.style.display !== 'none';

            const needNumeroRemessa = !id
                ? isSaltoUser(user)
                : (() => { const req = currentRequests.find(r => r.id === parseInt(id, 10)); return req && isSaltoRequest(req); })();
            if (needNumeroRemessa && isNumeroRemessaVisible) {
                const val = numeroRemessaEl ? numeroRemessaEl.value.trim() : '';
                if (!val) {
                    alert('N¬∫ Remessa √© obrigat√≥rio para solicita√ß√µes de Salto.');
                    return;
                }
            }

            const data = {
                material_code: document.getElementById('material-code').value,
                material_description: document.getElementById('material-description').value,
                quantidade: parseInt(document.getElementById('quantidade').value),
                unidade: document.getElementById('unidade').value,
                urgencia: document.getElementById('urgencia').value,
                deadline: document.getElementById('prazo').value || null,
                production_start_date: document.getElementById('inicio-producao').value || null,
                justificativa: document.getElementById('justificativa').value || null,
                entregar_em: document.getElementById('entregar-em').value || null
            };

            if (!id) {
                data.requester_name = document.getElementById('solicitante').value;
            }
            if (numeroRemessaEl && isNumeroRemessaVisible) {
                data.numero_remessa = numeroRemessaEl.value.trim() || null;
            }

            try {
                if (id) {
                    await updateRequest(id, data);
                    alert('Solicita√ß√£o atualizada com sucesso!');
                } else {
                    await createRequest(data);
                    alert('Solicita√ß√£o criada com sucesso!');
                }

                closeRequestModal();
                await loadRequests();
            } catch (error) {
                alert(`Erro ao salvar: ${getErrorMessage(error)}`);
            }
        };

        window.completeRequest = async function(id) {
            if (!confirm('Marcar esta solicita√ß√£o como conclu√≠da?')) return;

            try {
                await updateRequest(id, { status: 'Conclu√≠do' });
                alert('Solicita√ß√£o conclu√≠da!');
                await loadRequests();
            } catch (error) {
                alert(`Erro: ${getErrorMessage(error)}`);
            }
        };

        // Vari√°vel global para armazenar ID da solicita√ß√£o sendo recusada
        let solicitacaoRecusaId = null;

        // Fun√ß√£o para abrir modal de recusa
        window.recusarSeparacao = function(id) {
            solicitacaoRecusaId = id;
            document.getElementById('motivo-recusa').value = '';
            document.getElementById('modal-recusa').classList.add('active');
        };

        // Fun√ß√£o para fechar modal de recusa
        window.fecharModalRecusa = function() {
            document.getElementById('modal-recusa').classList.remove('active');
            solicitacaoRecusaId = null;
        };

        // Fun√ß√£o para confirmar recusa
        window.confirmarRecusa = async function() {
            const motivo = document.getElementById('motivo-recusa').value.trim();
            
            if (!motivo) {
                alert('Por favor, informe o motivo da recusa');
                return;
            }
            
            try {
                await updateRequest(solicitacaoRecusaId, { 
                    status: 'Recusado',
                    justificativa: `RECUSADO - Sem estoque: ${motivo}`
                });
                
                alert('Solicita√ß√£o recusada com sucesso');
                fecharModalRecusa();
                await loadRequests();
            } catch (error) {
                console.error('Erro ao recusar:', error);
                alert('Erro ao recusar solicita√ß√£o: ' + getErrorMessage(error));
            }
        };

        window.updateStatus = async function(id, newStatus) {
            const statusLabels = {
                'Pendente': 'Pendente',
                'Em Separa√ß√£o': 'Em Separa√ß√£o',
                'Conclu√≠do': 'Conclu√≠do',
                'Cancelado': 'Cancelado'
            };
            
            if (!confirm(`Alterar status para "${statusLabels[newStatus]}"?`)) return;

            try {
                await updateRequest(id, { status: newStatus });
                alert(`Status alterado para "${statusLabels[newStatus]}"!`);
                await loadRequests();
            } catch (error) {
                alert(`Erro: ${getErrorMessage(error)}`);
            }
        };

        window.revertToSeparation = async function(id) {
            try {
                await updateRequest(id, { status: 'Em Separa√ß√£o' });
                alert('Solicita√ß√£o revertida para Em Separa√ß√£o!');
                await loadRequests();
            } catch (error) {
                alert(`Erro ao reverter: ${getErrorMessage(error)}`);
            }
        };

        window.showHistory = async function(id) {
            document.getElementById('history-modal').classList.add('active');
            const timeline = document.getElementById('history-timeline');
            timeline.innerHTML = '<p style="text-align: center;">Carregando...</p>';

            try {
                const history = await getRequestHistory(id);
                
                if (history.length === 0) {
                    timeline.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhum hist√≥rico dispon√≠vel</p>';
                    return;
                }

                // Filtrar hist√≥rico de campos removidos
                const filteredHistory = history.filter(h => {
                    // Remover production_start_date (campo removido)
                    if (h.campo_alterado === 'production_start_date') {
                        return false;
                    }
                    
                    // Remover deadline ‚Üí null (prazo removido acidentalmente)
                    if (h.campo_alterado === 'deadline' && h.valor_novo === 'null') {
                        return false;
                    }
                    
                    return true;
                });

                timeline.innerHTML = filteredHistory.map(h => `
                    <div class="timeline-item">
                        <div class="timeline-time">${formatDateTime(h.timestamp)}</div>
                        <div class="timeline-content">
                            <div class="timeline-action">${getActionIcon(h.acao)} ${getActionLabel(h.acao)}</div>
                            <div class="timeline-details">
                                ${h.campo_alterado}: 
                                ${h.valor_anterior ? `<strong>${h.valor_anterior}</strong> ‚Üí ` : ''}
                                <strong>${h.valor_novo}</strong><br>
                                Por: ${h.usuario_nome}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                timeline.innerHTML = `<p style="color: var(--danger);">Erro ao carregar hist√≥rico</p>`;
            }
        };

        function getActionIcon(acao) {
            const icons = {
                'criado': 'üìù',
                'atualizado': '‚úèÔ∏è',
                'status_mudado': 'üîÑ',
                'conclu√≠do': '‚úÖ',
                'cancelado': '‚ùå'
            };
            return icons[acao] || 'üìå';
        }

        function getActionLabel(acao) {
            const labels = {
                'criado': 'Criado',
                'atualizado': 'Atualizado',
                'status_mudado': 'Status Alterado',
                'conclu√≠do': 'Conclu√≠do',
                'cancelado': 'Cancelado'
            };
            return labels[acao] || acao;
        }

        window.closeHistoryModal = function() {
            document.getElementById('history-modal').classList.remove('active');
        };

        // Fun√ß√µes de filtro por cards
        window.filterByAll = async function() {
            // Limpar todos os filtros
            document.getElementById('filter-id').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-urgencia').value = '';
            const fe = document.getElementById('filter-entregar-em');
            if (fe) fe.value = '';
            document.getElementById('search-input').value = '';
            document.getElementById('filter-data-solicitacao-inicio').value = '';
            document.getElementById('filter-data-solicitacao-fim').value = '';
            document.getElementById('filter-prazo-inicio').value = '';
            document.getElementById('filter-prazo-fim').value = '';
            currentPage = 1;
            
            // Recarregar todas as solicita√ß√µes
            await loadRequests();
        };

        window.filterByOverdue = async function() {
            document.getElementById('filter-id').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-urgencia').value = '';
            const fe = document.getElementById('filter-entregar-em');
            if (fe) fe.value = '';
            document.getElementById('search-input').value = '';
            document.getElementById('filter-data-solicitacao-inicio').value = '';
            document.getElementById('filter-data-solicitacao-fim').value = '';
            
            // Filtrar solicita√ß√µes atrasadas (deadline < hoje)
            // Usar data de ontem como deadline_end para pegar apenas os atrasados
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            yesterday.setHours(23, 59, 59, 0);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            document.getElementById('filter-prazo-inicio').value = '';
            document.getElementById('filter-prazo-fim').value = yesterdayStr;
            
            currentPage = 1;
            await loadRequests(true);
        };

        window.filterByDueToday = async function() {
            document.getElementById('filter-id').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-urgencia').value = '';
            const fe = document.getElementById('filter-entregar-em');
            if (fe) fe.value = '';
            document.getElementById('search-input').value = '';
            document.getElementById('filter-data-solicitacao-inicio').value = '';
            document.getElementById('filter-data-solicitacao-fim').value = '';
            
            // Filtrar solicita√ß√µes que vencem hoje (deadline = hoje)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('filter-prazo-inicio').value = todayStr;
            document.getElementById('filter-prazo-fim').value = todayStr;
            
            currentPage = 1;
            await loadRequests(true);
        };

        window.filterByCompleted = function() {
            document.getElementById('filter-id').value = '';
            document.getElementById('filter-status').value = 'Conclu√≠do';
            document.getElementById('filter-urgencia').value = '';
            const fe = document.getElementById('filter-entregar-em');
            if (fe) fe.value = '';
            document.getElementById('search-input').value = '';
            document.getElementById('filter-data-solicitacao-inicio').value = '';
            document.getElementById('filter-data-solicitacao-fim').value = '';
            document.getElementById('filter-prazo-inicio').value = '';
            document.getElementById('filter-prazo-fim').value = '';
            currentPage = 1;
            loadRequests(true);
        };

        // Fun√ß√£o auxiliar para corrigir solicita√ß√£o 350
        window.fixRequest350 = async function() {
            try {
                const user = getCurrentUser();
                if (!user || user.role !== 'admin') {
                    console.error('Erro: Apenas administradores podem executar corre√ß√µes');
                    showNotification('Apenas administradores podem executar corre√ß√µes', 'error');
                    return;
                }
                
                console.log('üîß Iniciando corre√ß√£o da solicita√ß√£o 350...');
                
                // Buscar solicita√ß√£o atual
                const request = await getRequest(350);
                console.log('üìù Solicita√ß√£o 350 encontrada:', request);
                console.log('   Valor atual:', request.quantidade);
                
                // Valor atual: 2377705 (2.377.705)
                // Valor corrigido: 2377 (2.377,705)
                const valorAtual = request.quantidade;
                const valorCorrigido = 2377;
                
                if (valorAtual === valorCorrigido) {
                    console.log('‚úÖ Solicita√ß√£o 350 j√° est√° com o valor correto');
                    showNotification('Solicita√ß√£o 350 j√° est√° com o valor correto', 'success');
                    return;
                }
                
                // Confirmar corre√ß√£o
                if (!confirm(`Corrigir quantidade da solicita√ß√£o 350?\n\nValor atual: ${valorAtual.toLocaleString('pt-BR')}\nValor corrigido: ${valorCorrigido.toLocaleString('pt-BR')}`)) {
                    return;
                }
                
                // Atualizar quantidade
                await updateRequest(350, { quantidade: valorCorrigido });
                
                console.log('‚úÖ Solicita√ß√£o 350 corrigida com sucesso!');
                showNotification('Solicita√ß√£o 350 corrigida com sucesso', 'success');
                
                // Recarregar lista
                await loadRequests();
                await loadDashboard();
            } catch (error) {
                console.error('‚ùå Erro ao corrigir solicita√ß√£o 350:', error);
                showNotification('Erro ao corrigir: ' + getErrorMessage(error), 'error');
            }
        };

        // Fun√ß√£o cancelar para solicitante
        window.cancelRequest = async function(id) {
            if (!confirm('Tem certeza que deseja cancelar esta solicita√ß√£o?')) return;
            
            try {
                await updateRequest(id, { status: 'Cancelado' });
                await loadRequests();
                await loadDashboard();
                showNotification('Solicita√ß√£o cancelada com sucesso', 'success');
            } catch (error) {
                showNotification('Erro ao cancelar: ' + getErrorMessage(error), 'error');
            }
        };

        // Fun√ß√£o deletar para admin
        window.deleteRequest = async function(id) {
            if (!confirm('Tem certeza que deseja EXCLUIR permanentemente esta solicita√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.')) return;
            
            try {
                console.log('Tentando excluir solicita√ß√£o:', id);
                const token = localStorage.getItem('auth_token');
                const user = getCurrentUser();
                console.log('Token presente:', !!token);
                console.log('Usu√°rio atual:', user?.role);
                
                // FIX: Se n√£o tem token, redirecionar para login imediatamente
                if (!token) {
                    alert('Sess√£o expirada. Fa√ßa login novamente.');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                    return;
                }
                
                const response = await fetch(`/.netlify/functions/requests/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    let errorMessage = 'Erro ao excluir';
                    try {
                        const error = await response.json();
                        // Log detalhado do erro
                        console.error('Erro do servidor (status ' + response.status + '):', JSON.stringify(error, null, 2));
                        
                        // FIX: Tentar extrair mensagem de erro tratando estruturas aninhadas
                        errorMessage = error.message 
                            || (error.error && typeof error.error === 'object' ? error.error.message : error.error)
                            || error.msg 
                            || error.details 
                            || (typeof error === 'string' ? error : JSON.stringify(error))
                            || errorMessage;
                            
                        console.log('Mensagem de erro extra√≠da:', errorMessage);
                    } catch (e) {
                        console.error('Erro ao parsear resposta JSON:', e);
                        console.error('Response status:', response.status);
                        console.error('Response statusText:', response.statusText);
                        
                        if (response.status === 401) {
                            errorMessage = 'Sess√£o expirada. Fa√ßa login novamente.';
                            setTimeout(() => {
                                localStorage.removeItem('token');
                                localStorage.removeItem('user');
                                window.location.href = 'login.html';
                            }, 2000);
                        } else if (response.status === 403) {
                            errorMessage = 'Sem permiss√£o para excluir. Apenas administradores podem excluir solicita√ß√µes.';
                        } else if (response.status === 404) {
                            errorMessage = 'Solicita√ß√£o n√£o encontrada.';
                        } else if (response.status === 500) {
                            errorMessage = 'Erro interno do servidor. Tente novamente.';
                        } else {
                            errorMessage = `Erro ${response.status}: ${response.statusText}`;
                        }
                    }
                    throw new Error(errorMessage);
                }
                
                console.log('Exclus√£o bem-sucedida');
                
                // Remover da lista local imediatamente
                currentRequests = currentRequests.filter(r => r.id !== id);
                renderRequests();
                
                // Recarregar para garantir sincroniza√ß√£o
                await loadRequests();
                await loadDashboard();
                
                alert('Solicita√ß√£o exclu√≠da com sucesso');
            } catch (error) {
                const errorMsg = error?.message || error?.toString() || 'Erro desconhecido ao excluir';
                alert('Erro ao excluir: ' + errorMsg);
                console.error('Erro ao excluir:', error);
                
                // Se for erro de autentica√ß√£o, redirecionar para login
                if (errorMsg.includes('autorizado') || errorMsg.includes('Sess√£o expirada') || errorMsg.includes('Token inv√°lido')) {
                    setTimeout(() => {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                    }, 2000);
                }
            }
        };

        window.printSelected = async function() {
            if (selectedIds.size === 0) return;

            try {
                await printPickingList(Array.from(selectedIds));
            } catch (error) {
                alert(`Erro ao gerar impress√£o: ${getErrorMessage(error)}`);
            }
        };

        window.exportSelectedToExcel = function() {
            if (selectedIds.size === 0) {
                alert('Nenhum item selecionado');
                return;
            }

            const selectedRequests = currentRequests.filter(req => selectedIds.has(req.id));
            
            if (selectedRequests.length === 0) {
                alert('Nenhum registro encontrado para exportar');
                return;
            }

            const excelData = selectedRequests.map(req => ({
                'ID': req.id,
                'Data Solicitacao': formatDateForExcel(req.created_at),
                'Urgencia': req.urgencia,
                'Prazo': req.deadline ? formatDateForExcel(req.deadline) : '',
                'Codigo': req.material_code,
                'Descricao': req.material_description,
                'Solicitante': req.solicitante_nome || req.requester_name,
                'Quantidade': Math.ceil(Number(req.quantidade)),
                'Unidade': req.unidade,
                'Status': req.status,
                'Observacao': req.justificativa || '',
                'Atualizado': formatDateForExcel(req.updated_at)
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            ws['!cols'] = [
                { wch: 8 }, { wch: 18 }, { wch: 10 }, { wch: 12 },
                { wch: 15 }, { wch: 40 }, { wch: 25 }, { wch: 12 },
                { wch: 8 }, { wch: 15 }, { wch: 40 }, { wch: 18 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Solicitacoes');

            const now = new Date();
            const fileName = `solicitacoes_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xlsx`;

            XLSX.writeFile(wb, fileName);

            alert(`${selectedRequests.length} registro(s) exportado(s) com sucesso!`);
        };

        function formatDateForExcel(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        window.handleImportFile = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tipo de arquivo
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Por favor, selecione um arquivo Excel (.xlsx ou .xls)');
                return;
            }

            // Validar tamanho (m√°ximo 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Arquivo muito grande. M√°ximo 5MB.');
                return;
            }

            if (!confirm(`Importar arquivo "${file.name}"? Esta a√ß√£o criar√° novas solicita√ß√µes.`)) {
                event.target.value = ''; // Limpar sele√ß√£o
                return;
            }

            try {
                // Converter arquivo para base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Enviar para API
                const response = await fetch('/.netlify/functions/import/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify({ file: base64, filename: file.name })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Importa√ß√£o conclu√≠da!\nSucessos: ${result.successCount}\nErros: ${result.errorCount}`);
                    if (result.errors && result.errors.length > 0) {
                        console.log('Erros de importa√ß√£o:', result.errors);
                    }
                    loadRequests(); // Recarregar lista
                } else {
                    throw new Error(result.error || 'Erro na importa√ß√£o');
                }
            } catch (error) {
                alert(`Erro na importa√ß√£o: ${getErrorMessage(error)}`);
            } finally {
                event.target.value = ''; // Limpar sele√ß√£o
            }
        };

        window.downloadTemplate = function() {
            window.location.href = '/.netlify/functions/import/template';
        };

        window.handleLogout = async function() {
            if (confirm('Deseja realmente sair?')) {
                await logout();
            }
        };

        // ============================================================================
        // NAVEGA√á√ÉO ENTRE ABAS
        // ============================================================================

        window.showTab = function(tabName) {
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('imports-section').style.display = 'none';
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            if (tabName === 'dashboard') {
                document.getElementById('dashboard-section').style.display = 'block';
                document.querySelector('.nav-link[href="#dashboard"]').classList.add('active');
            } else if (tabName === 'imports') {
                document.getElementById('imports-section').style.display = 'block';
                document.querySelector('.nav-link[href="#imports"]').classList.add('active');
                loadBatches();
            }
        };

        // ============================
        // Importa√ß√µes (Admin)
        // ============================
        async function authFetch(url, options = {}) {
            const token = localStorage.getItem('auth_token');
            return fetch(url, { ...options, headers: { ...(options.headers||{}), Authorization: `Bearer ${token}` } });
        }

        async function loadBatches() {
            try {
                const res = await authFetch('/.netlify/functions/imports?list=1');
                const data = await res.json();
                const el = document.getElementById('imports-batches');
                if (!res.ok) throw new Error(data?.error || 'Erro ao listar lotes');
                el.innerHTML = `
                    <table class="table">
                        <thead><tr>
                            <th>Lote</th><th>Criado em</th><th>Usu√°rio</th><th>Sucesso</th><th>Erros</th><th>Original</th><th>A√ß√µes</th>
                        </tr></thead>
                        <tbody>
                            ${data.batches.map(b => `
                                <tr>
                                    <td>${b.id}</td>
                                    <td>${new Date(b.created_at).toLocaleString('pt-BR')}</td>
                                    <td>${b.user_name || ''} (${b.user_email || ''})</td>
                                    <td>${b.success_count || 0}</td>
                                    <td>${b.error_count || 0}</td>
                                    <td>${b.has_original ? 'Dispon√≠vel' : '-'}</td>
                                    <td>
                                        <button class="btn btn-small" onclick="viewBatch(${b.id})">Ver itens</button>
                                        <button class="btn btn-small" onclick="downloadOriginal(${b.id})" ${b.has_original ? '' : 'disabled'}>Baixar original</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
            } catch (e) {
                alert(getErrorMessage(e));
            }
        }

        async function viewBatch(batchId) {
            try {
                const res = await authFetch(`/.netlify/functions/imports?batchId=${batchId}`);
                const data = await res.json();
                if (!res.ok) throw new Error(data?.error || 'Erro ao carregar itens do lote');
                const el = document.getElementById('imports-items');
                el.innerHTML = `
                    <h3>Itens do Lote #${batchId}</h3>
                    <table class="table">
                        <thead><tr>
                            <th>ID</th><th>Material</th><th>Descri√ß√£o</th><th>Qtd</th><th>Un</th><th>Urg√™ncia</th><th>Prazo</th><th>Criado em</th><th>Status</th>
                        </tr></thead>
                        <tbody>
                            ${data.items.map(r => `
                                <tr>
                                    <td>${r.id}</td>
                                    <td>${r.material_code}</td>
                                    <td>${r.descricao || ''}</td>
                                    <td>${Math.ceil(Number(r.quantidade)).toLocaleString('pt-BR')}</td>
                                    <td>${r.unidade || ''}</td>
                                    <td>${r.urgencia || ''}</td>
                                    <td>${r.prazo ? new Date(r.prazo).toLocaleDateString('pt-BR') : ''}</td>
                                    <td>${new Date(r.created_at).toLocaleString('pt-BR')}</td>
                                    <td>${r.status}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
            } catch (e) {
                alert(getErrorMessage(e));
            }
        }

        async function downloadOriginal(batchId) {
            try {
                const res = await authFetch(`/.netlify/functions/imports?downloadOriginal=1&batchId=${batchId}`);
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error?.error || 'Erro ao baixar arquivo');
                }
                
                // Obter nome do arquivo do header Content-Disposition
                const contentDisposition = res.headers.get('Content-Disposition');
                const filename = contentDisposition 
                    ? contentDisposition.split('filename=')[1]?.replace(/"/g, '') 
                    : `importacao_${batchId}.xlsx`;
                
                // Converter resposta para blob
                const blob = await res.blob();
                
                // Criar link de download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
            } catch (e) {
                alert('Erro ao baixar arquivo: ' + getErrorMessage(e));
            }
        }

        // Expor fun√ß√µes no escopo global para uso em onclick
        window.loadBatches = loadBatches;
        window.viewBatch = viewBatch;
        window.downloadOriginal = downloadOriginal;
    </script>
</body>
</html>

