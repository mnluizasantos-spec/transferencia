<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Transfer√™ncia de Material</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-title">
                    <h1>Sistema de Transfer√™ncia de Material</h1>
                    <div class="header-subtitle">Painel de Controle - Intercompany</div>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;" id="user-name">Carregando...</div>
                        <div style="font-size: 12px; opacity: 0.9;" id="user-role"></div>
                    </div>
                    <div class="user-avatar" id="user-avatar">?</div>
                </div>
                <button class="btn-logout" onclick="handleLogout()">Sair</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="app-nav">
        <div class="nav-container">
            <a href="#dashboard" class="nav-link active" onclick="showTab('dashboard')">üìä Dashboard</a>
            <a href="#reports" class="nav-link" onclick="showTab('reports')">üìà Relat√≥rios</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div id="dashboard-section" class="container">
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Total de Solicita√ß√µes</div>
                        <div class="stat-value" id="stat-total">-</div>
                    </div>
                    <div class="stat-icon">üì¶</div>
                </div>
            </div>

            <div class="stat-card danger clickable" onclick="filterByOverdue()">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Em Atraso</div>
                        <div class="stat-value" id="stat-atrasados">-</div>
                    </div>
                    <div class="stat-icon">‚ö†Ô∏è</div>
                </div>
            </div>

            <div class="stat-card warning clickable" onclick="filterByDueToday()">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Vencem Hoje</div>
                        <div class="stat-value" id="stat-hoje">-</div>
                    </div>
                    <div class="stat-icon">üïê</div>
                </div>
            </div>

            <div class="stat-card success clickable" onclick="filterByCompleted()">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Conclu√≠dos</div>
                        <div class="stat-value" id="stat-concluidos">-</div>
                    </div>
                    <div class="stat-icon">‚úÖ</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-panel">
            <div class="controls-row">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="üîç Buscar por material ou solicitante...">
                </div>
                <select id="filter-status">
                    <option value="">Todos os Status</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Em Separa√ß√£o">Em Separa√ß√£o</option>
                    <option value="Conclu√≠do">Conclu√≠do</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
                <select id="filter-urgencia">
                    <option value="">Todas as Urg√™ncias</option>
                    <option value="Urgente">Urgente</option>
                    <option value="Normal">Normal</option>
                </select>
                <button class="btn btn-secondary btn-small" onclick="downloadTemplate()">üì• Template Excel</button>
                <label class="btn btn-info btn-small" style="margin: 0 10px;">
                    üì§ Importar Excel
                    <input type="file" id="import-file" accept=".xlsx,.xls" style="display: none;" onchange="handleImportFile(event)">
                </label>
                <button class="btn btn-success" onclick="openRequestModal()">+ Nova Solicita√ß√£o</button>
            </div>
        </div>

        <!-- Selection Actions -->
        <div id="selection-actions" style="display: none; margin-bottom: 15px;">
            <span id="selection-info">0 itens selecionados</span>
            <button class="btn btn-primary btn-small" onclick="printSelected()" style="margin-left: 10px;">üñ®Ô∏è Imprimir Selecionados</button>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>ID</th>
                        <th>Urg√™ncia</th>
                        <th>Prazo</th>
                        <th>C√≥digo</th>
                        <th>Descri√ß√£o</th>
                        <th>Solicitante</th>
                        <th>Qtd/Unid</th>
                        <th>Status</th>
                        <th>Observa√ß√£o</th>
                        <th>Atualizado</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="requests-tbody">
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 40px;">
                            Carregando...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Reports Section -->
    <div id="reports-section" class="container" style="display: none;">
        <div class="section-header">
            <h2>üìà Relat√≥rios e An√°lises</h2>
            <p>An√°lise detalhada das solicita√ß√µes de material</p>
        </div>

        <!-- Date Filters -->
        <div class="filters-panel">
            <div class="filter-group">
                <label for="report-start-date">Data In√≠cio:</label>
                <input type="date" id="report-start-date" class="filter-input">
            </div>
            <div class="filter-group">
                <label for="report-end-date">Data Fim:</label>
                <input type="date" id="report-end-date" class="filter-input">
            </div>
            <button class="btn btn-primary" onclick="loadReports()">üìä Gerar Relat√≥rio</button>
            <button class="btn btn-secondary" onclick="printReports()">üñ®Ô∏è Imprimir</button>
        </div>

        <!-- Metrics Cards -->
        <div class="reports-stats-grid">
            <div class="stat-card info">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Tempo M√©dio de Envio</div>
                        <div class="stat-value" id="report-avg-time">-</div>
                    </div>
                    <div class="stat-icon">‚è±Ô∏è</div>
                </div>
            </div>
            
            <div class="stat-card primary">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Total no Per√≠odo</div>
                        <div class="stat-value" id="report-total-period">-</div>
                    </div>
                    <div class="stat-icon">üìä</div>
                </div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Taxa de Conclus√£o</div>
                        <div class="stat-value" id="report-completion-rate">-</div>
                    </div>
                    <div class="stat-icon">‚úÖ</div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de Materiais Full Width -->
        <div class="chart-full-width">
            <h3>üì¶ Materiais Mais Solicitados</h3>
            <canvas id="materials-chart"></canvas>
        </div>

        <!-- Charts Grid - Outros Gr√°ficos -->
        <div class="charts-grid-two">
            <div class="chart-container">
                <h3>üìà Solicita√ß√µes por Status</h3>
                <canvas id="status-chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>üìÖ Solicita√ß√µes por Dia</h3>
                <canvas id="daily-chart"></canvas>
            </div>
        </div>

        <!-- Tables -->
        <div class="tables-section">
            <div class="table-container">
                <h3>üèÜ Top 10 Materiais Mais Solicitados</h3>
                     <table id="top-materials-table">
                         <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Material</th>
                                <th>Qtd Total</th>
                                <th>Qtd Req.</th>
                                <th>% Total</th>
                            </tr>
                         </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align: center; padding: 20px;">Selecione um per√≠odo para gerar o relat√≥rio</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Solicita√ß√£o -->
    <div class="modal-overlay" id="request-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Nova Solicita√ß√£o</h2>
                <p id="modal-subtitle">Preencha os dados para criar uma nova solicita√ß√£o</p>
            </div>
            <div class="modal-body">
                <form id="request-form">
                    <input type="hidden" id="request-id">

                    <div class="form-group">
                        <label for="material-code">C√≥digo do Material *</label>
                        <input type="text" id="material-code" required placeholder="Ex: MP001, COMP002">
                    </div>

                    <div class="form-group">
                        <label for="material-description">Descri√ß√£o do Material *</label>
                        <input type="text" id="material-description" required placeholder="Ex: Mat√©ria-Prima X123 - A√ßo inoxid√°vel">
                    </div>

                    <div class="form-group">
                        <label for="quantidade">Quantidade *</label>
                        <input type="number" id="quantidade" required min="1" placeholder="Ex: 100">
                    </div>

                    <div class="form-group">
                        <label for="unidade">Unidade *</label>
                        <select id="unidade" required>
                            <option value="">Selecione a unidade</option>
                            <option value="kg">kg (Quilograma)</option>
                            <option value="pc">pc (Pe√ßa)</option>
                            <option value="m">m (Metro)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="solicitante">Solicitante *</label>
                        <input type="text" id="solicitante" required placeholder="Nome do solicitante">
                    </div>

                    <div class="form-group">
                        <label for="urgencia">Urg√™ncia</label>
                        <select id="urgencia">
                            <option value="Normal">Normal</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="prazo">Prazo *</label>
                        <input type="date" id="prazo" required>
                    </div>

                    <div class="form-group">
                        <label for="inicio-producao">In√≠cio de Produ√ß√£o</label>
                        <input type="date" id="inicio-producao">
                    </div>

                    <div class="form-group">
                        <label for="justificativa">Justificativa</label>
                        <textarea id="justificativa" placeholder="Opcional: descreva o motivo da solicita√ß√£o"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRequestModal()">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveRequest()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Hist√≥rico -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Hist√≥rico da Solicita√ß√£o</h2>
                <p>Timeline completa de altera√ß√µes</p>
            </div>
            <div class="modal-body">
                <div id="history-timeline" class="timeline">
                    <p style="text-align: center; color: var(--text-secondary);">Carregando hist√≥rico...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeHistoryModal()">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { requireAuth, getCurrentUser, logout, isAdmin, isSeparador } from '/js/auth.js';
        import { getRequests, getDashboardStats, createRequest, updateRequest, deleteRequest, getRequestHistory, printPickingList } from '/js/api.js';

        // Verificar token ao carregar p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('auth_token');
            const user = localStorage.getItem('current_user');
            
            // Se tem user mas n√£o tem token, limpar tudo e redirecionar
            if (user && !token) {
                console.warn('Usu√°rio sem token v√°lido, redirecionando para login');
                localStorage.removeItem('current_user');
                window.location.href = 'login.html';
                return;
            }
            
            // Se n√£o tem nem user nem token, redirecionar
            if (!user && !token) {
                window.location.href = 'login.html';
                return;
            }
        });

        // Verificar autentica√ß√£o
        if (!requireAuth()) {
            window.location.href = '/login.html';
        }

        // Estado global
        let currentRequests = [];
        let selectedIds = new Set();
        let editingRequestId = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            initializeUser();
            setupRoleVisibility();
            loadDashboard();
            loadRequests();
            setupEventListeners();
        });

        function initializeUser() {
            const user = getCurrentUser();
            if (!user) return;

            const userName = user.name || user.nome || 'Usu√°rio';
            const userRole = user.role || 'user';
            
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-role').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
            
            const initials = userName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;
        }

        function setupRoleVisibility() {
            const user = getCurrentUser();
            if (!user) return;
            
            // Esconder funcionalidades para separador (s√≥ pode processar, n√£o criar)
            if (user.role === 'separador') {
                // Esconder importa√ß√£o Excel
                const importLabel = document.querySelector('label.btn-info');
                if (importLabel) importLabel.style.display = 'none';
                
                // Esconder template Excel
                const templateBtn = document.querySelector('.btn-secondary');
                if (templateBtn && templateBtn.textContent.includes('Template')) {
                    templateBtn.style.display = 'none';
                }
                
                // Esconder bot√£o Nova Solicita√ß√£o
                const novaSolicitacaoBtn = document.querySelector('button.btn-success');
                if (novaSolicitacaoBtn && novaSolicitacaoBtn.textContent.includes('Nova Solicita√ß√£o')) {
                    novaSolicitacaoBtn.style.display = 'none';
                }
            }
        }

        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', debounce(loadRequests, 300));
            document.getElementById('filter-status').addEventListener('change', loadRequests);
            document.getElementById('filter-urgencia').addEventListener('change', loadRequests);
            document.getElementById('select-all').addEventListener('change', handleSelectAll);

            // Fechar modais ao clicar fora
            document.getElementById('request-modal').addEventListener('click', (e) => {
                if (e.target.id === 'request-modal') closeRequestModal();
            });
            document.getElementById('history-modal').addEventListener('click', (e) => {
                if (e.target.id === 'history-modal') closeHistoryModal();
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        async function loadDashboard() {
            try {
                const stats = await getDashboardStats();
                document.getElementById('stat-total').textContent = stats.total;
                document.getElementById('stat-atrasados').textContent = stats.atrasados;
                document.getElementById('stat-hoje').textContent = stats.vencem_hoje;
                document.getElementById('stat-concluidos').textContent = stats.concluidos;
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        async function loadRequests() {
            const search = document.getElementById('search-input').value;
            const status = document.getElementById('filter-status').value;
            const urgencia = document.getElementById('filter-urgencia').value;

            const filters = {};
            if (search) filters.search = search;
            if (status) filters.status = status;
            if (urgencia) filters.urgencia = urgencia;

            try {
                currentRequests = await getRequests(filters);
                renderRequests();
                loadDashboard(); // Atualizar estat√≠sticas
            } catch (error) {
                console.error('Erro ao carregar solicita√ß√µes:', error);
                document.getElementById('requests-tbody').innerHTML = `
                    <tr><td colspan="12" style="text-align: center; color: var(--danger);">
                        Erro ao carregar solicita√ß√µes: ${error.message}
                    </td></tr>
                `;
            }
        }

        function getActionButtons(req) {
            const user = getCurrentUser();
            if (!user) return '';
            
            const userRole = user.role;
            const isOwner = req.created_by === user.id || req.requester_name === (user.name || user.nome);
            const isCompleted = req.status === 'Conclu√≠do';
            
            let buttons = '';
            
            if (userRole === 'admin') {
                // Admin: pode fazer tudo
                if (!isCompleted) {
                    buttons += `<button class="btn btn-primary btn-small" onclick="editRequest(${req.id})" title="Editar">‚úèÔ∏è</button>`;
                    buttons += `<button class="btn btn-success btn-small" onclick="completeRequest(${req.id})" title="Concluir">‚úì</button>`;
                    buttons += `<button class="btn btn-warning btn-small" onclick="updateStatus(${req.id}, 'Em Separa√ß√£o')" title="Marcar como Em Separa√ß√£o">üì¶</button>`;
                }
                // Bot√£o de exclus√£o (sempre vis√≠vel para admin)
                buttons += `<button class="btn btn-danger btn-small" onclick="deleteRequest(${req.id})" title="Excluir">üóëÔ∏è</button>`;
            } else if (userRole === 'separador') {
                // Separador: pode alterar status e concluir, mas n√£o editar dados
                if (!isCompleted) {
                    if (req.status === 'Pendente') {
                        buttons += `<button class="btn btn-warning btn-small" onclick="updateStatus(${req.id}, 'Em Separa√ß√£o')" title="Iniciar Separa√ß√£o">üì¶</button>`;
                    } else if (req.status === 'Em Separa√ß√£o') {
                        buttons += `<button class="btn btn-success btn-small" onclick="completeRequest(${req.id})" title="Concluir">‚úì</button>`;
                    }
                }
            } else if (userRole === 'solicitante') {
                // Solicitante: s√≥ pode cancelar suas pr√≥prias solicita√ß√µes
                if (isOwner && !isCompleted) {
                    if (['Pendente', 'Em Separa√ß√£o'].includes(req.status)) {
                        buttons += `<button class="btn btn-danger btn-small" onclick="cancelRequest(${req.id})" title="Cancelar">‚ùå</button>`;
                    }
                }
            }
            
            return buttons;
        }

        function renderRequests() {
            const tbody = document.getElementById('requests-tbody');
            
            if (currentRequests.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="12" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        Nenhuma solicita√ß√£o encontrada
                    </td></tr>
                `;
                return;
            }

            tbody.innerHTML = currentRequests.map(req => `
                <tr>
                    <td><input type="checkbox" class="row-checkbox" data-id="${req.id}"></td>
                    <td><strong>#${req.id}</strong></td>
                    <td>
                        <span class="badge ${req.urgencia.toLowerCase()}">${req.urgencia}</span>
                    </td>
                    <td>${formatPrazo(req.deadline, req.status)}</td>
                    <td><strong>${req.material_code || req.material}</strong></td>
                    <td>${req.material_description || '-'}</td>
                    <td>${req.solicitante_nome || req.requester_name}</td>
                    <td>${req.quantidade} ${req.unidade || ''}</td>
                    <td>
                        <span class="badge ${req.status.toLowerCase().replace(' ', '-')}">${req.status}</span>
                    </td>
                    <td>${req.justificativa ? (req.justificativa.length > 50 ? req.justificativa.substring(0, 50) + '...' : req.justificativa) : '-'}</td>
                    <td>${formatDateTime(req.updated_at)}</td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="showHistory(${req.id})" title="Hist√≥rico">üìã</button>
                        ${getActionButtons(req)}
                    </td>
                </tr>
            `).join('');

            // Adicionar event listeners aos checkboxes
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.addEventListener('change', handleCheckboxChange);
            });
        }

        function formatPrazo(deadline, status) {
            if (!deadline || status === 'Conclu√≠do') return '-';
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            // FIX: Validar deadline antes de processar
            let deadlineDate;
            try {
                // Limpar deadline - pode vir com timezone ou n√£o
                let cleanDeadline = deadline;
                if (typeof deadline === 'string') {
                    // Se tem timezone, extrair apenas a data
                    if (deadline.includes('T')) {
                        cleanDeadline = deadline.split('T')[0];
                    }
                    // Adicionar timezone para evitar problemas
                    deadlineDate = new Date(cleanDeadline + 'T12:00:00');
                } else {
                    // Se n√£o √© string, tentar converter
                    deadlineDate = new Date(deadline);
                }
                
                // Validar se √© uma data v√°lida
                if (isNaN(deadlineDate.getTime())) {
                    console.warn('Data inv√°lida no prazo:', deadline);
                    return '-';
                }
                
                deadlineDate.setHours(0, 0, 0, 0);
            } catch (error) {
                console.error('Erro ao formatar prazo:', deadline, error);
                return '-';
            }
            
            const diff = Math.ceil((deadlineDate - hoje) / (1000 * 60 * 60 * 24));
            
            let className = '';
            let label = '';
            
            if (diff < 0) {
                className = 'danger';
                label = `<br><small>(${Math.abs(diff)} dias de atraso)</small>`;
            } else if (diff === 0) {
                className = 'warning';
                label = '<br><small>(Vence hoje!)</small>';
            } else {
                className = 'success';
                label = `<br><small>(${diff} dias)</small>`;
            }
            
            return `<span style="color: var(--${className}); font-weight: 600;">${deadlineDate.toLocaleDateString('pt-BR')}${label}</span>`;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString('pt-BR');
        }

        function handleSelectAll(e) {
            const checked = e.target.checked;
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = checked;
            });
            updateSelectedIds();
        }

        function handleCheckboxChange() {
            updateSelectedIds();
        }

        function updateSelectedIds() {
            selectedIds.clear();
            document.querySelectorAll('.row-checkbox:checked').forEach(cb => {
                selectedIds.add(parseInt(cb.dataset.id));
            });

            const count = selectedIds.size;
            document.getElementById('selection-info').textContent = `${count} ${count === 1 ? 'item selecionado' : 'itens selecionados'}`;
            document.getElementById('selection-actions').style.display = count > 0 ? 'block' : 'none';
        }

        window.openRequestModal = function() {
            editingRequestId = null;
            document.getElementById('modal-title').textContent = 'Nova Solicita√ß√£o';
            document.getElementById('modal-subtitle').textContent = 'Preencha os dados para criar uma nova solicita√ß√£o';
            document.getElementById('request-form').reset();
            document.getElementById('request-id').value = '';
            document.getElementById('request-modal').classList.add('active');
        };

        window.closeRequestModal = function() {
            document.getElementById('request-modal').classList.remove('active');
        };

        window.editRequest = function(id) {
            const request = currentRequests.find(r => r.id === id);
            if (!request) return;

            editingRequestId = id;
            document.getElementById('modal-title').textContent = 'Editar Solicita√ß√£o';
            document.getElementById('modal-subtitle').textContent = `Editando solicita√ß√£o #${id}`;
            
            document.getElementById('request-id').value = id;
            document.getElementById('material-code').value = request.material_code || '';
            document.getElementById('material-description').value = request.material_description || '';
            document.getElementById('quantidade').value = request.quantidade;
            document.getElementById('unidade').value = request.unidade || '';
            document.getElementById('solicitante').value = request.solicitante_nome || request.requester_name || '';
            document.getElementById('urgencia').value = request.urgencia;
            // Extrair apenas a data (yyyy-mm-dd) do deadline para o input type="date"
            const prazoValue = request.deadline ? request.deadline.split('T')[0] : '';
            document.getElementById('prazo').value = prazoValue;
            document.getElementById('justificativa').value = request.justificativa || '';

            document.getElementById('request-modal').classList.add('active');
        };

        window.saveRequest = async function() {
            const id = document.getElementById('request-id').value;
            const data = {
                material_code: document.getElementById('material-code').value,
                material_description: document.getElementById('material-description').value,
                quantidade: parseInt(document.getElementById('quantidade').value),
                unidade: document.getElementById('unidade').value,
                urgencia: document.getElementById('urgencia').value,
                deadline: document.getElementById('prazo').value || null,
                production_start_date: document.getElementById('inicio-producao').value || null,
                justificativa: document.getElementById('justificativa').value || null
            };

            // Adicionar solicitante apenas para novos (backend resolve o resto)
            if (!id) {
                data.requester_name = document.getElementById('solicitante').value;
            }

            try {
                if (id) {
                    await updateRequest(id, data);
                    alert('Solicita√ß√£o atualizada com sucesso!');
                } else {
                    await createRequest(data);
                    alert('Solicita√ß√£o criada com sucesso!');
                }

                closeRequestModal();
                await loadRequests();
            } catch (error) {
                alert(`Erro ao salvar: ${error.message}`);
            }
        };

        window.completeRequest = async function(id) {
            if (!confirm('Marcar esta solicita√ß√£o como conclu√≠da?')) return;

            try {
                await updateRequest(id, { status: 'Conclu√≠do' });
                alert('Solicita√ß√£o conclu√≠da!');
                await loadRequests();
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        };

        window.updateStatus = async function(id, newStatus) {
            const statusLabels = {
                'Pendente': 'Pendente',
                'Em Separa√ß√£o': 'Em Separa√ß√£o',
                'Conclu√≠do': 'Conclu√≠do',
                'Cancelado': 'Cancelado'
            };
            
            if (!confirm(`Alterar status para "${statusLabels[newStatus]}"?`)) return;

            try {
                await updateRequest(id, { status: newStatus });
                alert(`Status alterado para "${statusLabels[newStatus]}"!`);
                await loadRequests();
            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        };

        window.showHistory = async function(id) {
            document.getElementById('history-modal').classList.add('active');
            const timeline = document.getElementById('history-timeline');
            timeline.innerHTML = '<p style="text-align: center;">Carregando...</p>';

            try {
                const history = await getRequestHistory(id);
                
                if (history.length === 0) {
                    timeline.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhum hist√≥rico dispon√≠vel</p>';
                    return;
                }

                // Filtrar hist√≥rico de campos removidos
                const filteredHistory = history.filter(h => {
                    // Remover production_start_date (campo removido)
                    if (h.campo_alterado === 'production_start_date') {
                        return false;
                    }
                    
                    // Remover deadline ‚Üí null (prazo removido acidentalmente)
                    if (h.campo_alterado === 'deadline' && h.valor_novo === 'null') {
                        return false;
                    }
                    
                    return true;
                });

                timeline.innerHTML = filteredHistory.map(h => `
                    <div class="timeline-item">
                        <div class="timeline-time">${formatDateTime(h.timestamp)}</div>
                        <div class="timeline-content">
                            <div class="timeline-action">${getActionIcon(h.acao)} ${getActionLabel(h.acao)}</div>
                            <div class="timeline-details">
                                ${h.campo_alterado}: 
                                ${h.valor_anterior ? `<strong>${h.valor_anterior}</strong> ‚Üí ` : ''}
                                <strong>${h.valor_novo}</strong><br>
                                Por: ${h.usuario_nome}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                timeline.innerHTML = `<p style="color: var(--danger);">Erro ao carregar hist√≥rico</p>`;
            }
        };

        function getActionIcon(acao) {
            const icons = {
                'criado': 'üìù',
                'atualizado': '‚úèÔ∏è',
                'status_mudado': 'üîÑ',
                'conclu√≠do': '‚úÖ',
                'cancelado': '‚ùå'
            };
            return icons[acao] || 'üìå';
        }

        function getActionLabel(acao) {
            const labels = {
                'criado': 'Criado',
                'atualizado': 'Atualizado',
                'status_mudado': 'Status Alterado',
                'conclu√≠do': 'Conclu√≠do',
                'cancelado': 'Cancelado'
            };
            return labels[acao] || acao;
        }

        window.closeHistoryModal = function() {
            document.getElementById('history-modal').classList.remove('active');
        };

        // Fun√ß√µes de filtro por cards
        window.filterByOverdue = function() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-urgencia').value = '';
            // TODO: Implementar filtro customizado para atrasados
            loadRequests();
        };

        window.filterByDueToday = function() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-urgencia').value = '';
            // TODO: Implementar filtro customizado para vencem hoje
            loadRequests();
        };

        window.filterByCompleted = function() {
            document.getElementById('filter-status').value = 'Conclu√≠do';
            document.getElementById('filter-urgencia').value = '';
            loadRequests();
        };

        // Fun√ß√£o cancelar para solicitante
        window.cancelRequest = async function(id) {
            if (!confirm('Tem certeza que deseja cancelar esta solicita√ß√£o?')) return;
            
            try {
                await updateRequest(id, { status: 'Cancelado' });
                await loadRequests();
                await loadDashboard();
                showNotification('Solicita√ß√£o cancelada com sucesso', 'success');
            } catch (error) {
                showNotification('Erro ao cancelar: ' + error.message, 'error');
            }
        };

        // Fun√ß√£o deletar para admin
        window.deleteRequest = async function(id) {
            if (!confirm('Tem certeza que deseja EXCLUIR permanentemente esta solicita√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.')) return;
            
            try {
                console.log('Tentando excluir solicita√ß√£o:', id);
                const token = localStorage.getItem('auth_token');
                const user = getCurrentUser();
                console.log('Token presente:', !!token);
                console.log('Usu√°rio atual:', user?.role);
                
                // FIX: Se n√£o tem token, redirecionar para login imediatamente
                if (!token) {
                    alert('Sess√£o expirada. Fa√ßa login novamente.');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                    return;
                }
                
                const response = await fetch(`/.netlify/functions/requests/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    let errorMessage = 'Erro ao excluir';
                    try {
                        const error = await response.json();
                        // Log detalhado do erro
                        console.error('Erro do servidor (status ' + response.status + '):', JSON.stringify(error, null, 2));
                        
                        // FIX: Tentar extrair mensagem de erro tratando estruturas aninhadas
                        errorMessage = error.message 
                            || (error.error && typeof error.error === 'object' ? error.error.message : error.error)
                            || error.msg 
                            || error.details 
                            || (typeof error === 'string' ? error : JSON.stringify(error))
                            || errorMessage;
                            
                        console.log('Mensagem de erro extra√≠da:', errorMessage);
                    } catch (e) {
                        console.error('Erro ao parsear resposta JSON:', e);
                        console.error('Response status:', response.status);
                        console.error('Response statusText:', response.statusText);
                        
                        if (response.status === 401) {
                            errorMessage = 'Sess√£o expirada. Fa√ßa login novamente.';
                            setTimeout(() => {
                                localStorage.removeItem('token');
                                localStorage.removeItem('user');
                                window.location.href = 'login.html';
                            }, 2000);
                        } else if (response.status === 403) {
                            errorMessage = 'Sem permiss√£o para excluir. Apenas administradores podem excluir solicita√ß√µes.';
                        } else if (response.status === 404) {
                            errorMessage = 'Solicita√ß√£o n√£o encontrada.';
                        } else if (response.status === 500) {
                            errorMessage = 'Erro interno do servidor. Tente novamente.';
                        } else {
                            errorMessage = `Erro ${response.status}: ${response.statusText}`;
                        }
                    }
                    throw new Error(errorMessage);
                }
                
                console.log('Exclus√£o bem-sucedida');
                
                // Remover da lista local imediatamente
                currentRequests = currentRequests.filter(r => r.id !== id);
                renderRequests();
                
                // Recarregar para garantir sincroniza√ß√£o
                await loadRequests();
                await loadDashboard();
                
                alert('Solicita√ß√£o exclu√≠da com sucesso');
            } catch (error) {
                const errorMsg = error?.message || error?.toString() || 'Erro desconhecido ao excluir';
                alert('Erro ao excluir: ' + errorMsg);
                console.error('Erro ao excluir:', error);
                
                // Se for erro de autentica√ß√£o, redirecionar para login
                if (errorMsg.includes('autorizado') || errorMsg.includes('Sess√£o expirada') || errorMsg.includes('Token inv√°lido')) {
                    setTimeout(() => {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                    }, 2000);
                }
            }
        };

        window.printSelected = async function() {
            if (selectedIds.size === 0) return;

            try {
                await printPickingList(Array.from(selectedIds));
            } catch (error) {
                alert(`Erro ao gerar impress√£o: ${error.message}`);
            }
        };

        window.handleImportFile = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tipo de arquivo
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Por favor, selecione um arquivo Excel (.xlsx ou .xls)');
                return;
            }

            // Validar tamanho (m√°ximo 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Arquivo muito grande. M√°ximo 5MB.');
                return;
            }

            if (!confirm(`Importar arquivo "${file.name}"? Esta a√ß√£o criar√° novas solicita√ß√µes.`)) {
                event.target.value = ''; // Limpar sele√ß√£o
                return;
            }

            try {
                // Converter arquivo para base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Enviar para API
                const response = await fetch('/.netlify/functions/import/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify({ file: base64, filename: file.name })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Importa√ß√£o conclu√≠da!\nSucessos: ${result.successCount}\nErros: ${result.errorCount}`);
                    if (result.errors && result.errors.length > 0) {
                        console.log('Erros de importa√ß√£o:', result.errors);
                    }
                    loadRequests(); // Recarregar lista
                } else {
                    throw new Error(result.error || 'Erro na importa√ß√£o');
                }
            } catch (error) {
                alert(`Erro na importa√ß√£o: ${error.message}`);
            } finally {
                event.target.value = ''; // Limpar sele√ß√£o
            }
        };

        window.downloadTemplate = function() {
            window.location.href = '/.netlify/functions/import/template';
        };

        window.handleLogout = async function() {
            if (confirm('Deseja realmente sair?')) {
                await logout();
            }
        };

        // ============================================================================
        // NAVEGA√á√ÉO ENTRE ABAS
        // ============================================================================

        window.showTab = function(tabName) {
            // Esconder todas as se√ß√µes
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('reports-section').style.display = 'none';
            
            // Remover classe active de todos os links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Mostrar se√ß√£o selecionada e marcar link como ativo
            if (tabName === 'dashboard') {
                document.getElementById('dashboard-section').style.display = 'block';
                document.querySelector('.nav-link[href="#dashboard"]').classList.add('active');
            } else if (tabName === 'reports') {
                document.getElementById('reports-section').style.display = 'block';
                document.querySelector('.nav-link[href="#reports"]').classList.add('active');
                
                // Definir datas padr√£o (√∫ltimos 30 dias)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 30);
                
                document.getElementById('report-end-date').value = endDate.toISOString().split('T')[0];
                document.getElementById('report-start-date').value = startDate.toISOString().split('T')[0];
            }
        };

        // ============================================================================
        // FUN√á√ïES DE RELAT√ìRIOS
        // ============================================================================

        // Vari√°veis globais para gr√°ficos
        let materialsChart = null;
        let statusChart = null;
        let dailyChart = null;

        window.loadReports = async function() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            console.log('Gerando relat√≥rio:', { startDate, endDate });
            
            if (!startDate || !endDate) {
                alert('Por favor, selecione as datas de in√≠cio e fim');
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify({ startDate, endDate })
                });
                
                const data = await response.json();
                console.log('Dados recebidos:', data);
                
                if (response.ok) {
                    updateReportMetrics(data);
                    updateReportCharts(data);
                    updateReportTables(data);
                } else {
                    throw new Error(data.error || 'Erro ao carregar relat√≥rios');
                }
            } catch (error) {
                console.error('Erro ao carregar relat√≥rios:', error);
                alert('Erro ao carregar relat√≥rios: ' + error.message);
            }
        };

        function updateReportMetrics(data) {
            // Tempo m√©dio
            const avgHours = data.avgTime?.hours || 0;
            document.getElementById('report-avg-time').textContent = 
                avgHours > 0 ? `${Math.round(avgHours)}h` : '-';
            
            // Total no per√≠odo
            const total = data.daily?.reduce((sum, day) => sum + day.count, 0) || 0;
            document.getElementById('report-total-period').textContent = total;
            
            // Taxa de conclus√£o
            const completed = data.byStatus?.find(s => s.status === 'Conclu√≠do')?.count || 0;
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('report-completion-rate').textContent = `${completionRate}%`;
        }

        function updateReportCharts(data) {
            // Destruir gr√°ficos existentes
            if (materialsChart) {
                materialsChart.destroy();
                materialsChart = null;
            }
            if (statusChart) {
                statusChart.destroy();
                statusChart = null;
            }
            if (dailyChart) {
                dailyChart.destroy();
                dailyChart = null;
            }
            
            console.log('Dados para gr√°ficos:', data);
            
            // Gr√°fico de materiais
            const materialsCtx = document.getElementById('materials-chart').getContext('2d');
            materialsChart = new Chart(materialsCtx, {
                type: 'bar',
                data: {
                    labels: data.topMaterials?.slice(0, 10).map(m => m.material_description.substring(0, 50) + '...') || [],
                    datasets: [{
                        label: 'Quantidade',
                        data: data.topMaterials?.slice(0, 10).map(m => m.total) || [],
                        backgroundColor: '#4682B4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Quantidade: ' + context.parsed.y.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });

            // Gr√°fico de status
            const statusCtx = document.getElementById('status-chart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: data.byStatus?.map(s => s.status) || [],
                    datasets: [{
                        data: data.byStatus?.map(s => s.count) || [],
                        backgroundColor: ['#e74c3c', '#f39c12', '#27ae60', '#3498db']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Gr√°fico di√°rio
            const dailyCtx = document.getElementById('daily-chart').getContext('2d');
            dailyChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: data.daily?.map(d => d.date) || [],
                    datasets: [{
                        label: 'Solicita√ß√µes',
                        data: data.daily?.map(d => d.count) || [],
                        borderColor: '#4682B4',
                        backgroundColor: 'rgba(70, 130, 180, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateReportTables(data) {
            const tbody = document.querySelector('#top-materials-table tbody');
            if (data.topMaterials?.length > 0) {
                // Calcular total geral
                const grandTotal = data.topMaterials.reduce((sum, m) => sum + parseInt(m.total), 0);
                
                tbody.innerHTML = data.topMaterials.slice(0, 10).map((material, index) => {
                    const quantity = parseInt(material.total);
                    const requestsCount = parseInt(material.requests_count || 0);
                    const percentage = grandTotal > 0 ? ((quantity / grandTotal) * 100).toFixed(1) : 0;
                    
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${material.material_description}</td>
                            <td>${quantity.toLocaleString('pt-BR')}</td>
                            <td>${requestsCount}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Nenhum dado encontrado para o per√≠odo selecionado</td></tr>';
            }
        }

        window.printReports = function() {
            window.print();
        };
    </script>
</body>
</html>

